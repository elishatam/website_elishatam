<html xmlns:v="urn:schemas-microsoft-com:vml"
xmlns:o="urn:schemas-microsoft-com:office:office"
xmlns:w="urn:schemas-microsoft-com:office:word"
xmlns="http://www.w3.org/TR/REC-html40">

<head>
<meta http-equiv=Content-Type content="text/html; charset=windows-1252">
<meta name=ProgId content=Word.Document>
<meta name=Generator content="Microsoft Word 11">
<meta name=Originator content="Microsoft Word 11">
<link rel=File-List href="Motors_files/filelist.xml">
<title>Motors</title>
<!--[if gte mso 9]><xml>
 <o:DocumentProperties>
  <o:Author>sabrina</o:Author>
  <o:Template>Normal</o:Template>
  <o:LastAuthor>sabrina</o:LastAuthor>
  <o:Revision>2</o:Revision>
  <o:TotalTime>1</o:TotalTime>
  <o:Created>2010-03-10T10:05:00Z</o:Created>
  <o:LastSaved>2010-03-10T10:08:00Z</o:LastSaved>
  <o:Pages>1</o:Pages>
  <o:Words>938</o:Words>
  <o:Characters>5350</o:Characters>
  <o:Lines>44</o:Lines>
  <o:Paragraphs>12</o:Paragraphs>
  <o:CharactersWithSpaces>6276</o:CharactersWithSpaces>
  <o:Version>11.9999</o:Version>
 </o:DocumentProperties>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:WordDocument>
  <w:Zoom>75</w:Zoom>
  <w:SpellingState>Clean</w:SpellingState>
  <w:GrammarState>Clean</w:GrammarState>
  <w:PunctuationKerning/>
  <w:ValidateAgainstSchemas/>
  <w:SaveIfXMLInvalid>false</w:SaveIfXMLInvalid>
  <w:IgnoreMixedContent>false</w:IgnoreMixedContent>
  <w:AlwaysShowPlaceholderText>false</w:AlwaysShowPlaceholderText>
  <w:Compatibility>
   <w:BreakWrappedTables/>
   <w:SnapToGridInCell/>
   <w:WrapTextWithPunct/>
   <w:UseAsianBreakRules/>
   <w:DontGrowAutofit/>
  </w:Compatibility>
  <w:BrowserLevel>MicrosoftInternetExplorer4</w:BrowserLevel>
 </w:WordDocument>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:LatentStyles DefLockedState="false" LatentStyleCount="156">
 </w:LatentStyles>
</xml><![endif]-->
<style>
<!--
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{mso-style-parent:"";
	margin:0in;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:12.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";}
h2
	{mso-style-link:"Heading 2 Char";
	mso-style-next:Normal;
	margin-top:12.0pt;
	margin-right:0in;
	margin-bottom:3.0pt;
	margin-left:0in;
	mso-pagination:widow-orphan;
	page-break-after:avoid;
	mso-outline-level:2;
	font-size:14.0pt;
	font-family:Arial;
	font-style:italic;}
span.Heading2Char
	{mso-style-name:"Heading 2 Char";
	mso-style-locked:yes;
	mso-style-link:"Heading 2";
	mso-ansi-font-size:14.0pt;
	mso-bidi-font-size:14.0pt;
	font-family:Arial;
	mso-ascii-font-family:Arial;
	mso-hansi-font-family:Arial;
	mso-bidi-font-family:Arial;
	mso-ansi-language:EN-US;
	mso-fareast-language:EN-US;
	mso-bidi-language:AR-SA;
	font-weight:bold;
	font-style:italic;}
span.SpellE
	{mso-style-name:"";
	mso-spl-e:yes;}
span.GramE
	{mso-style-name:"";
	mso-gram-e:yes;}
@page Section1
	{size:8.5in 11.0in;
	margin:1.0in 1.25in 1.0in 1.25in;
	mso-header-margin:.5in;
	mso-footer-margin:.5in;
	mso-paper-source:0;}
div.Section1
	{page:Section1;}
-->
</style>
<!--[if gte mso 10]>
<style>
 /* Style Definitions */
 table.MsoNormalTable
	{mso-style-name:"Table Normal";
	mso-tstyle-rowband-size:0;
	mso-tstyle-colband-size:0;
	mso-style-noshow:yes;
	mso-style-parent:"";
	mso-padding-alt:0in 5.4pt 0in 5.4pt;
	mso-para-margin:0in;
	mso-para-margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:10.0pt;
	font-family:"Times New Roman";
	mso-ansi-language:#0400;
	mso-fareast-language:#0400;
	mso-bidi-language:#0400;}
</style>
<![endif]--><!--[if gte mso 9]><xml>
 <o:shapedefaults v:ext="edit" spidmax="3074"/>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <o:shapelayout v:ext="edit">
  <o:idmap v:ext="edit" data="1"/>
 </o:shapelayout></xml><![endif]-->
</head>

<body lang=EN-US style='tab-interval:.5in'>

<div class=Section1>

<h2 style='margin:0in;margin-bottom:.0001pt'><a name="_Toc255781703"></a><span
class=SpellE><span style='mso-bookmark:_Toc255781703'><span style='font-size:
12.0pt;mso-bidi-font-size:14.0pt;font-family:"Times New Roman";mso-bidi-font-family:
Arial;font-style:normal'>Motors.c</span></span></span><span style='mso-bookmark:
_Toc255781703'></span><span style='font-size:12.0pt;mso-bidi-font-size:14.0pt;
font-family:"Times New Roman";mso-bidi-font-family:Arial;font-style:normal'><o:p></o:p></span></h2>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

<p class=MsoNormal><span class=GramE><b style='mso-bidi-font-weight:normal'><span
style='font-size:10.0pt;font-family:Arial'>void</span></b></span><b
style='mso-bidi-font-weight:normal'><span style='font-size:10.0pt;font-family:
Arial'> <span class=SpellE>Motors_Init</span>(void) <o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-left:.5in'><span style='font-size:10.0pt;
font-family:Arial'>Setup IC for encoder and OC for PID control<o:p></o:p></span></p>

<p class=MsoNormal style='margin-left:.5in'><span style='font-size:10.0pt;
font-family:Arial'>Make sure 1 ms timer is running<o:p></o:p></span></p>

<p class=MsoNormal style='margin-left:.5in'><span style='font-size:10.0pt;
font-family:Arial'>Setup PWM using PWM modules<o:p></o:p></span></p>

<p class=MsoNormal style='margin-left:.5in'><span style='font-size:10.0pt;
font-family:Arial'>Set <span class=SpellE>prescale</span> to 24MHz/4 =6MHz<o:p></o:p></span></p>

<p class=MsoNormal style='margin-left:.5in'><span style='font-size:10.0pt;
font-family:Arial'>Set <span class=SpellE>postscale</span> to --&gt; 6MHz<span
class=GramE>/(</span>4*2)=7.5kHz<o:p></o:p></span></p>

<p class=MsoNormal style='margin-left:.5in'><span style='font-size:10.0pt;
font-family:Arial'>Period contains 200 ticks --&gt;PWM frequency = <span
class=GramE>7.5kHz</span><span style='mso-tab-count:1'>     </span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-left:.5in'><span style='font-size:10.0pt;
font-family:Arial'>Set duty cycles to zero for both motors<o:p></o:p></span></p>

<p class=MsoNormal style='margin-left:.5in'><span style='font-size:10.0pt;
font-family:Arial'>Reset encoder counts<span style='mso-tab-count:1'>    </span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-left:.5in'><span style='font-size:10.0pt;
font-family:Arial'>Assume motors are stopped, so timeout period calculation<o:p></o:p></span></p>

<p class=MsoNormal style='margin-left:.5in'><span style='font-size:10.0pt;
font-family:Arial'>Set motors as unlocked, so that PID control doesn't force
them to match speeds<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span class=GramE><b style='mso-bidi-font-weight:normal'><span
style='font-size:10.0pt;font-family:Arial'>void</span></b></span><b
style='mso-bidi-font-weight:normal'><span style='font-size:10.0pt;font-family:
Arial'> <span class=SpellE>Motors_resetPosition</span>(void) <o:p></o:p></span></b></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>Reset encoder counts<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span class=SpellE><b style='mso-bidi-font-weight:normal'><span
style='font-size:10.0pt;font-family:Arial'>MOTOR_State_t</span></b></span><b
style='mso-bidi-font-weight:normal'><span style='font-size:10.0pt;font-family:
Arial'> <span class=SpellE>Motors_<span class=GramE>getState</span></span><span
class=GramE>(</span>void) <o:p></o:p></span></b></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>If the desired speed for both motors
is zero<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span><span class=SpellE><span
class=GramE>controlStopped</span></span> is TRUE<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>Else<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span><span class=SpellE><span
class=GramE>controlStopped</span></span> is FALSE<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>If the actual speed for both motors
is zero<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span><span class=SpellE><span
class=GramE>physicallyStopped</span></span> is TRUE<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>Else<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span><span class=SpellE><span
class=GramE>physicallyStopped</span></span> is FALSE<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='margin-left:.5in'><span style='font-size:10.0pt;
font-family:Arial'>If <span class=SpellE>controlStopped</span><o:p></o:p></span></p>

<p class=MsoNormal style='margin-left:.5in'><span style='font-size:10.0pt;
font-family:Arial'><span style='mso-tab-count:1'>            </span><span
style='mso-spacerun:yes'>  </span>If <span class=SpellE>physicallyStopped</span>
return MOTORS_STOPPED;<o:p></o:p></span></p>

<p class=MsoNormal style='margin-left:.5in'><span style='font-size:10.0pt;
font-family:Arial'><span style='mso-tab-count:1'>            </span><span
style='mso-spacerun:yes'>  </span>Else return MOTORS_STOPPING;<o:p></o:p></span></p>

<p class=MsoNormal style='margin-left:.5in'><span style='font-size:10.0pt;
font-family:Arial'>Else return MOTORS_MOVING;<o:p></o:p></span></p>

<p class=MsoNormal style='margin-left:.5in'><span style='font-size:10.0pt;
font-family:Arial'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span class=GramE><b style='mso-bidi-font-weight:normal'><span
style='font-size:10.0pt;font-family:Arial'>float</span></b></span><b
style='mso-bidi-font-weight:normal'><span style='font-size:10.0pt;font-family:
Arial'> <span class=SpellE>Motors_getNetDistance</span>(void) <o:p></o:p></span></b></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>Return average of the encoder counts
divided by the number of counts per inch<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span class=GramE><b style='mso-bidi-font-weight:normal'><span
style='font-size:10.0pt;font-family:Arial'>float</span></b></span><b
style='mso-bidi-font-weight:normal'><span style='font-size:10.0pt;font-family:
Arial'> <span class=SpellE>Motors_getDegreesTurned</span>(void) <o:p></o:p></span></b></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span><span class=GramE>Difference<span
style='mso-spacerun:yes'>  </span>=</span> Absolute Value of (Motor0 encoder
count - Motor1 encoder count)<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>Return 360
*Difference/2/EncoderCountsPerRevolution<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span class=GramE><b style='mso-bidi-font-weight:normal'><span
style='font-size:10.0pt;font-family:Arial'>long</span></b></span><b
style='mso-bidi-font-weight:normal'><span style='font-size:10.0pt;font-family:
Arial'> <span class=SpellE>Motors_getEncoderCount</span>(<span class=SpellE>int</span>
<span class=SpellE>motorNum</span>) <o:p></o:p></span></b></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>If <span class=SpellE>motorNum</span>
is zero <o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span>Return Motor0 Encoder
Count<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-spacerun:yes'>   </span><span style='mso-tab-count:1'>         </span>Else<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span>Return Motor1 Encoder
Count<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span class=GramE><b style='mso-bidi-font-weight:normal'><span
style='font-size:10.0pt;font-family:Arial'>void</span></b></span><b
style='mso-bidi-font-weight:normal'><span style='font-size:10.0pt;font-family:
Arial'> <span class=SpellE>Motors_moveDiff</span>(<span class=SpellE>int</span>
spd1, <span class=SpellE>int</span> spd0) <o:p></o:p></span></b></p>

<p class=MsoNormal style='margin-left:.5in'><span style='font-size:10.0pt;
font-family:Arial'>Note: inputs speeds = [-100, 100]<o:p></o:p></span></p>

<p class=MsoNormal style='margin-left:.5in'><span class=SpellE><span
style='font-size:10.0pt;font-family:Arial'>Temorarily</span></span><span
style='font-size:10.0pt;font-family:Arial'> turn off PID control using a flag<o:p></o:p></span></p>

<p class=MsoNormal style='margin-left:.5in'><span style='font-size:10.0pt;
font-family:Arial'>Set desired speeds equal to <span class=SpellE>inputSpeed</span>*<span
class=SpellE>maxSpeed</span><o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>If spd1 = spd0<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span>Set speeds as locked,
PID will keep motors at the same speed<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>Else<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span>Set speeds as unlocked<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>Turn PID control back on<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span class=GramE><b style='mso-bidi-font-weight:normal'><span
style='font-size:10.0pt;font-family:Arial'>void</span></b></span><b
style='mso-bidi-font-weight:normal'><span style='font-size:10.0pt;font-family:
Arial'> <span class=SpellE>Motors_moveStraight</span>(<span class=SpellE>int</span>
<span class=SpellE>spd</span>)<o:p></o:p></span></b></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span><span class=SpellE>Motors_<span
class=GramE>moveDiff</span></span><span class=GramE>(</span><span class=SpellE>spd</span>,
<span class=SpellE>spd</span>)<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span class=GramE><b style='mso-bidi-font-weight:normal'><span
style='font-size:10.0pt;font-family:Arial'>void</span></b></span><b
style='mso-bidi-font-weight:normal'><span style='font-size:10.0pt;font-family:
Arial'> <span class=SpellE>Motors_turn</span>(<span class=SpellE>MOTOR_TurnDir_t</span>
dir, <span class=SpellE>int</span> <span class=SpellE>spd</span>)<o:p></o:p></span></b></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>If dir = CW<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span><span class=SpellE>Motors_<span
class=GramE>moveDiff</span></span><span class=GramE>(</span><span class=SpellE>spd</span>,
-1*<span class=SpellE>spd</span>);<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>Else<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span><span class=SpellE>Motors_<span
class=GramE>moveDiff</span></span><span class=GramE>(</span>-1*<span
class=SpellE>spd</span>, <span class=SpellE>spd</span>);<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span class=GramE><b style='mso-bidi-font-weight:normal'><span
style='font-size:10.0pt;font-family:Arial'>void</span></b></span><b
style='mso-bidi-font-weight:normal'><span style='font-size:10.0pt;font-family:
Arial'> <span class=SpellE>Motors_moveStraightStop</span>(<span class=SpellE>int</span>
<span class=SpellE>spd</span>, float inches)<o:p></o:p></span></b></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span><span class=SpellE>Motors_<span
class=GramE>moveDiff</span></span><span class=GramE>(</span><span class=SpellE>spd,spd</span>)<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span><span class=SpellE>Motors_<span
class=GramE>resetPosition</span></span><span class=GramE>()</span><o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>Set number of encoder counts to move
equal to inches*<span class=SpellE>EncoderTicksPerInch</span><o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>Set flag that each motor should stop
when desired number of encoder ticks has been reached<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span class=GramE><b style='mso-bidi-font-weight:normal'><span
style='font-size:10.0pt;font-family:Arial'>void</span></b></span><b
style='mso-bidi-font-weight:normal'><span style='font-size:10.0pt;font-family:
Arial'> <span class=SpellE>Motors_turnStop</span>(<span class=SpellE>MOTOR_TurnDir_t</span>
dir, <span class=SpellE>int</span> <span class=SpellE>spd</span>, unsigned <span
class=SpellE>int</span> degrees)<o:p></o:p></span></b></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span><span class=SpellE>Motors_<span
class=GramE>turn</span></span><span class=GramE>(</span>dir, <span
class=SpellE>spd</span>)<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>Set <span class=SpellE>myEncoderTicks</span>
equal to degrees* EncoderTicksPerRevolution/360<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>If dir = CCW<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span>desEncoderCount0 = <span
class=SpellE>myEncoderTicks</span><o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span>desEncoderCount1 = -1*<span
class=SpellE>myEncoderTicks</span><o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>Else<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span>desEncoderCount0 = -1*<span
class=SpellE>myEncoderTicks</span>;<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span>desEncoderCount1 = <span
class=SpellE>myEncoderTicks</span>;<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span><span class=SpellE>Motors_<span
class=GramE>resetPosition</span></span><span class=GramE>(</span>);<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>Set flag that each motor should stop
when desired number of encoder ticks has been reached<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span class=GramE><b style='mso-bidi-font-weight:normal'><span
style='font-size:10.0pt;font-family:Arial'>void</span></b></span><b
style='mso-bidi-font-weight:normal'><span style='font-size:10.0pt;font-family:
Arial'> <span class=SpellE>Timers_Init</span>(void)<o:p></o:p></span></b></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>Turn on timer system to allow Input
Capture<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-spacerun:yes'>  </span><span style='mso-tab-count:1'>          </span>Set
pre-scale /8 = 3MHz<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>Set Cap/Comp 5 to Output Compare and
the rest to Input Capture<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-spacerun:yes'>  </span><span style='mso-tab-count:1'>          </span>For
Input Captures on encoder signals, capture rising edges<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>Clear flags<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>Enable Interrupts<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>For Output Compare for PID control,
don't connect to any pin<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>Schedule first rise for Output
Compare for 20 [ms] in time<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>Clear flag<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>Enable Interrupts<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span class=GramE><b style='mso-bidi-font-weight:normal'><span
style='font-size:10.0pt;font-family:Arial'>void</span></b></span><b
style='mso-bidi-font-weight:normal'><span style='font-size:10.0pt;font-family:
Arial'> interrupt _Vec_tim1ch5 <span class=SpellE>EncoderOC_PID_DC</span>(void)<o:p></o:p></span></b></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>Note: experimentally determined
runtime for this interrupt routine to be &lt;200[us]<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>Locally store variables shared
between encoder Input Capture interrupt routine and this Output Compare PID
control interrupt routine<span style='mso-spacerun:yes'>  </span><o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>Check <span class=SpellE>newEdgeOccured</span>
flags indicating that a new edge has occurred since the last PID loop<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>If no new edge has occurred<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span>Timeout the encoders,
meaning two rising edges are required to calculate new period<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>Else<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span>Reset new edge flag<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-spacerun:yes'>  </span><o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-spacerun:yes'>  </span><span style='mso-tab-count:1'>          </span>Clear
interrupt flag<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>Program next compare to occur in 20
[ms]<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>Enable interrupts to ensure encoder
input capture interrupts still occur<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>If PID control flag has been
disabled<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span>Return<span
style='mso-spacerun:yes'>  </span><o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>Convert <span class=SpellE>uPeriods</span>
to speeds [RPM]<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>Determine Commanded Speed for Motor1
(slower motor)<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span>First calculate speed
limit based on nearing end position<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:3'>                                    </span>Error = <span
class=SpellE>desEncoderCount</span> - <span class=SpellE>EncoderCount</span>;<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:3'>                                    </span><span
class=SpellE><span class=GramE>spdLimit</span></span> = <span class=SpellE>Kp_pos</span>*Error<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span><span class=SpellE><span
class=GramE>newDesSpd</span></span> = min(<span class=SpellE>spdLimit</span>, <span
class=SpellE>desSpd</span>)<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>Determine Commanded Speed for Motor0
(slower motor)<span style='mso-tab-count:1'>   </span><o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span>If in locked mode<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:3'>                                    </span>cmdSpd0 =
cmdSpd1;<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span>Else If in opposite
locked mode<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:3'>                                    </span>cmdSpd0 =
-1*cmdSpd1;<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span>Else<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:3'>                                    </span>Error = <span
class=SpellE>desEncoderCount</span> - <span class=SpellE>EncoderCount</span>;<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:3'>                                    </span><span
class=SpellE><span class=GramE>spdLimit</span></span> = <span class=SpellE>Kp_pos</span>*Error<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:3'>                                    </span><span
class=SpellE><span class=GramE>newDesSpd</span></span> = min(<span
class=SpellE>spdLimit</span>, <span class=SpellE>desSpd</span>)<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span><o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span>Determine speed error for
PI control of speed for both motors<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span>Calculate authority
based off PI terms and speed error<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span>If <span class=SpellE>curSpd</span>
is zero and <span class=SpellE>cmdSpd</span> is zero<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:3'>                                    </span>Set
authority to zero<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span>Calculate authority
limit for both motors (based on speed-&gt;<span class=SpellE>backEMF</span>)<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span>Limit = (<span
class=SpellE>CurrentMax</span>*<span class=SpellE>Res_coils</span> +
EMF)*200[Duty Cycle Max]/16 [V]<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span>Apply limits to
commanded authority to protect motor drivers<span style='mso-tab-count:1'>         </span><o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span>If at the limit<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:3'>                                    </span>Saturate
duty cycle and prevent integrator wind-up<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span>Update duty cycle to
implement speed control<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span class=GramE><b style='mso-bidi-font-weight:normal'><span
style='font-size:10.0pt;font-family:Arial'>void</span></b></span><b
style='mso-bidi-font-weight:normal'><span style='font-size:10.0pt;font-family:
Arial'> interrupt _Vec_tim1ch4 <span class=SpellE>EncoderICRoutine</span>(void)<o:p></o:p></span></b></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>Note: same code for both motors, but
located in different interrupt routines<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>Clear interrupt flag<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>If <span class=SpellE>EncoderTimeout</span>
flag<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span>Can't make period
calculation until a second rising edge occurs<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>Else<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span>Calculate elapsed time
since last rising edge<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span>Check to make sure
period calculation is realistic, if not ignore it<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-spacerun:yes'>  </span><span style='mso-tab-count:1'>          </span>Store
time of this rising edge<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>Read B Channel of Encoder<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>If B Channel is HI<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span>Decrement encoder count<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span>Set direction to
BACKWARD<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>Else<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span>Increment encoder count<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span>Set direction to FORWARD<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>If flag is set indicating motors
should stop after a given distance<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span>If encoder count is at
that desired distance<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:3'>                                    </span>Set desired
speed of motors to zero<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:3'>                                    </span>Reset flag
indicating motors should stop after given distance<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span class=GramE><b style='mso-bidi-font-weight:normal'><span
style='font-size:10.0pt;font-family:Arial'>static</span></b></span><b
style='mso-bidi-font-weight:normal'><span style='font-size:10.0pt;font-family:
Arial'> void Motor0(<span class=SpellE>int</span> <span class=SpellE>inputDC</span>)<o:p></o:p></span></b></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>Note: <span class=SpellE>inputDC</span>
= [-200, 200]<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-spacerun:yes'>  </span><span style='mso-tab-count:1'>          </span>Negate
input duty cycle command because motor 0 needs to spin &quot;backwards&quot;
for the robot to go forwards<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-spacerun:yes'>  </span><span style='mso-tab-count:1'>          </span>If
<span class=SpellE>inputDC</span> &gt; 0<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span>Set one side of coil
driver low<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span>Set PWM duty on other
side of coil to input duty cycle<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>Else If <span class=SpellE>inputDC</span>
&lt; 0<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span>Set one side of coil
driver high<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span>Set PWM duty on other
side of coil to 200 + <span class=SpellE>inputDC</span><o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>Else<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span>Set one side of coil <span
class=SpellE>driverlow</span><o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span>Set PWM duty on other
side of coil to zero<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span class=GramE><b style='mso-bidi-font-weight:normal'><span
style='font-size:10.0pt;font-family:Arial'>static</span></b></span><b
style='mso-bidi-font-weight:normal'><span style='font-size:10.0pt;font-family:
Arial'> void Motor1(<span class=SpellE>int</span> <span class=SpellE>inputDC</span>)<o:p></o:p></span></b></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>Note: <span class=SpellE>inputDC</span>
= [-200, 200]<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-spacerun:yes'>  </span><span style='mso-tab-count:1'>          </span>If
<span class=SpellE>inputDC</span> &gt; 0<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span>Set one side of coil
driver low<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span>Set PWM duty on other
side of coil to input duty cycle<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>Else If <span class=SpellE>inputDC</span>
&lt; 0<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span>Set one side of coil
driver high<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span>Set PWM duty on other
side of coil to 200 + <span class=SpellE>inputDC</span><o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:1'>            </span>Else<o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span>Set one side of coil <span
class=SpellE>driverlow</span><o:p></o:p></span></p>

<p class=MsoNormal><span style='font-size:10.0pt;font-family:Arial'><span
style='mso-tab-count:2'>                        </span>Set PWM duty on other
side of coil to zero<o:p></o:p></span></p>

<p class=MsoNormal><o:p>&nbsp;</o:p></p>

</div>

</body>

</html>
